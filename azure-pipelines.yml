pool:
   vmImage: 'ubuntu-latest'
variables:
  GOBIN: "$(GOPATH)/bin"
  GOPATH: "$(system.defaultWorkingDirectory)/gopath"
  modulePath: "$(GOPATH)/src/github.com/$(build.repository.name)"
  GOROOT: "/usr/local/go1.14"
steps: 
- task: GoTool@0
  inputs:
    version: '1.14.6'
- script: |
    set -e -x
    mkdir -p '$(GOPATH)/bin'
    echo '##vso[task.prependpath]$(GOROOT)/bin'
    echo '##vso[task.prependpath]$(GOPATH)/bin'
  displayName: 'Create Go Workspace'
- bash: |
    wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v1.27.0
    export PATH="$PATH:./bin"
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "Download golangci-lint"
- bash: |
    make build
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "make build"
- task: CopyFiles@2
  inputs:
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
- task: PublishBuildArtifacts@1
  inputs:
     artifactName: drop
- bash: |
    make go-test
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: "make go-test"
- bash: |
    golangci-lint run ./...
  workingDirectory: '$(System.DefaultWorkingDirectory)'
